<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js Meta Quest VRコントローラー表示</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        canvas {
            display: block;
        }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: white;
            font-family: Arial, sans-serif;
            pointer-events: none;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="info">
        <p>Meta Quest VRコントローラー表示</p>
        <p>VRデバイスを接続してVRモードを開始するには「VRを開始」ボタンをクリックしてください</p>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Three.jsの初期化
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x202020);
        
        // カメラの設定
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.6, 3);
        
        // レンダラーの設定
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);
        
        // VRButtonの定義
        const VRButton = {
            createButton: function(renderer, options) {
                if (options && options.referenceSpaceType) {
                    renderer.xr.setReferenceSpaceType(options.referenceSpaceType);
                }

                const button = document.createElement('button');
                button.style.display = 'block';
                button.style.position = 'absolute';
                button.style.bottom = '20px';
                button.style.padding = '12px';
                button.style.border = '1px solid #fff';
                button.style.borderRadius = '4px';
                button.style.background = 'rgba(0,0,0,0.1)';
                button.style.color = '#fff';
                button.style.font = 'normal 13px sans-serif';
                button.style.textAlign = 'center';
                button.style.opacity = '0.5';
                button.style.outline = 'none';
                button.style.zIndex = '999';
                button.style.cursor = 'pointer';
                button.style.left = 'calc(50% - 50px)';
                button.style.width = '100px';
                button.textContent = 'VRを開始';

                function showEnterVR() {
                    let currentSession = null;

                    async function onSessionStarted(session) {
                        session.addEventListener('end', onSessionEnded);

                        await renderer.xr.setSession(session);
                        button.textContent = 'VRを終了';
                        button.style.display = '';

                        currentSession = session;
                    }

                    function onSessionEnded() {
                        currentSession.removeEventListener('end', onSessionEnded);

                        button.textContent = 'VRを開始';
                        button.style.display = '';

                        currentSession = null;
                    }

                    button.style.display = '';
                    button.style.cursor = 'pointer';
                    button.style.opacity = '1.0';

                    button.onclick = function() {
                        if (currentSession === null) {
                            // WebXR's requestReferenceSpace only works if the corresponding feature
                            // was requested at session creation time.
                            const sessionInit = {
                                optionalFeatures: ['local-floor', 'bounded-floor', 'hand-tracking', 'layers']
                            };
                            navigator.xr.requestSession('immersive-vr', sessionInit)
                                .then(onSessionStarted)
                                .catch(err => {
                                    console.error('VRセッションの開始に失敗しました:', err);
                                    alert('VRセッションの開始に失敗しました。VRデバイスが接続されていることを確認してください。');
                                });
                        } else {
                            currentSession.end();
                        }
                    };
                }

                button.onclick = function() {
                    if ('xr' in navigator) {
                        navigator.xr.isSessionSupported('immersive-vr')
                            .then(function(supported) {
                                if (supported) {
                                    showEnterVR();
                                } else {
                                    button.textContent = 'VR非対応';
                                    button.style.opacity = '0.5';
                                    button.style.cursor = 'auto';
                                    alert('お使いのブラウザまたはデバイスはVRに対応していません。');
                                }
                            });
                    } else {
                        button.textContent = 'VR非対応';
                        button.style.opacity = '0.5';
                        button.style.cursor = 'auto';
                        alert('お使いのブラウザはWebXRに対応していません。');
                    }
                };

                return button;
            }
        };
        
        // VRボタンの追加
        document.body.appendChild(VRButton.createButton(renderer));
        
        // ライトの追加
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(1, 1, 1).normalize();
        scene.add(directionalLight);
        
        // 床のグリッドを作成
        const gridHelper = new THREE.GridHelper(10, 10);
        scene.add(gridHelper);
        
        // コントローラーモデルを表示するためのヘルパーオブジェクト
        const controllerModelFactory = new THREE.XRControllerModelFactory();
        
        // コントローラーの設定
        const controllers = [];
        const controllerGrips = [];
        
        for (let i = 0; i < 2; i++) {
            // コントローラーの作成
            const controller = renderer.xr.getController(i);
            controller.addEventListener('connected', function(event) {
                const mesh = buildController(event.data);
                this.add(mesh);
            });
            controller.addEventListener('disconnected', function() {
                this.remove(this.children[0]);
            });
            scene.add(controller);
            controllers.push(controller);
            
            // コントローラーグリップの作成
            const controllerGrip = renderer.xr.getControllerGrip(i);
            const controllerModel = controllerModelFactory.createControllerModel(controllerGrip);
            controllerGrip.add(controllerModel);
            scene.add(controllerGrip);
            controllerGrips.push(controllerGrip);
        }
        
        // コントローラーの視覚化（シンプルな表示用）
        function buildController(data) {
            let geometry, material;
            
            switch (data.targetRayMode) {
                case 'tracked-pointer':
                    // ポインターとして表示
                    geometry = new THREE.BufferGeometry();
                    geometry.setAttribute('position', new THREE.Float32BufferAttribute([0, 0, 0, 0, 0, -1], 3));
                    geometry.setAttribute('color', new THREE.Float32BufferAttribute([0.5, 0.5, 0.5, 0, 0, 0], 3));
                    
                    material = new THREE.LineBasicMaterial({
                        vertexColors: true,
                        blending: THREE.AdditiveBlending
                    });
                    
                    return new THREE.Line(geometry, material);
                    
                case 'gaze':
                    // 凝視ポインターとして表示
                    geometry = new THREE.RingGeometry(0.02, 0.04, 32).translate(0, 0, -1);
                    material = new THREE.MeshBasicMaterial({
                        opacity: 0.5,
                        transparent: true
                    });
                    return new THREE.Mesh(geometry, material);
                default:
                    return new THREE.Object3D();
            }
        }
        
        // XRセッションが変更された時の処理
        function onSessionChange(event) {
            const session = renderer.xr.getSession();
            
            if (session) {
                // VRセッションが開始された場合
                document.getElementById('info').style.display = 'none';
            } else {
                // VRセッションが終了した場合
                document.getElementById('info').style.display = 'block';
            }
        }
        
        renderer.xr.addEventListener('sessionstart', onSessionChange);
        renderer.xr.addEventListener('sessionend', onSessionChange);
        
        // ウィンドウリサイズ対応
        window.addEventListener('resize', onWindowResize, false);
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // アニメーションループ
        function animate() {
            renderer.setAnimationLoop(render);
        }
        
        function render() {
            // コントローラーの状態を更新
            for (let i = 0; i < controllers.length; i++) {
                if (controllers[i].userData.isSelecting) {
                    // 選択ボタンが押されている場合の処理
                }
            }
            
            renderer.render(scene, camera);
        }
        
        // XRControllerModelFactoryの定義
        // 通常はimportするが、ここではインラインで定義
        THREE.XRControllerModelFactory = (function() {
            function XRControllerModel() {
                THREE.Object3D.call(this);
                
                this.motionController = null;
                this.envMap = null;
            }
            
            XRControllerModel.prototype = Object.assign(Object.create(THREE.Object3D.prototype), {
                constructor: XRControllerModel,
                
                setEnvironmentMap: function(envMap) {
                    this.envMap = envMap;
                    
                    if (this.envMap) {
                        this.traverse((child) => {
                            if (child.isMesh) {
                                child.material.envMap = this.envMap;
                                child.material.needsUpdate = true;
                            }
                        });
                    }
                }
            });
            
            function XRControllerModelFactory() {
                this.gltfLoader = null;
            }
            
            XRControllerModelFactory.prototype = {
                constructor: XRControllerModelFactory,
                
                createControllerModel: function(controllerGrip) {
                    const model = new XRControllerModel();
                    
                    // シンプルなコントローラーモデル作成（実際のモデルは読み込まず簡易表示）
                    const geometry = new THREE.BoxGeometry(0.08, 0.08, 0.16);
                    const material = new THREE.MeshStandardMaterial({
                        color: 0x404040,
                        roughness: 0.7,
                        metalness: 0.3
                    });
                    
                    const controllerMesh = new THREE.Mesh(geometry, material);
                    controllerMesh.position.z = -0.08;
                    
                    // ボタン表現
                    const buttonGeometry = new THREE.CylinderGeometry(0.01, 0.01, 0.01, 16);
                    const buttonMaterial = new THREE.MeshStandardMaterial({
                        color: 0x222222
                    });
                    const button = new THREE.Mesh(buttonGeometry, buttonMaterial);
                    button.position.set(0, 0.03, -0.03);
                    button.rotation.x = Math.PI / 2;
                    controllerMesh.add(button);
                    
                    // トリガー表現
                    const triggerGeometry = new THREE.BoxGeometry(0.05, 0.02, 0.04);
                    const trigger = new THREE.Mesh(triggerGeometry, buttonMaterial);
                    trigger.position.set(0, -0.03, -0.06);
                    controllerMesh.add(trigger);
                    
                    model.add(controllerMesh);
                    
                    return model;
                }
            };
            
            return XRControllerModelFactory;
        })();
        
        // アニメーションを開始
        animate();
    </script>
</body>
</html>